<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History | Hannes & Co.</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="icon" type="image/svg+xml" href="./images/header/favicon.svg">
    <style>
        /* CSS for your website */
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styles */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            line-height: 1.6;
            margin-bottom: 100px; /* Adjusted to make space for the fixed footer */
        }

        /* Header Styles */
        .header {
            background-color: #333;
            color: white;
            padding: 10px 0;
        }

        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            width: 100px;
            height: auto;
        }

        .nav-menu ul {
            list-style-type: none;
            display: flex;
        }

        .nav-item {
            margin-right: 20px;
        }

        /* Form Styles */
        .profilePage {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 100px); /* Adjust for header height */
        }

        .orders {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            width: 100%; /* Modified to fit the container */
            overflow-x: auto; /* Added overflow handling for smaller screens */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .orders h3 {
            margin-bottom: 20px;
            color: #333;
            text-align: center;
        }

        .orders table {
            width: 100%; /* Modified to fit the container */
            border-collapse: collapse;
            margin-top: 20px;
            color: #333;
        }

        .orders th, .orders td {
            border: 1px solid #ddd;
            padding: 15px;
        }

        .orders th {
            background-color: #333;
            color: white;
        }

        .orders tbody tr:nth-child(even) {
            background-color: #f9f9f9;
            color: #333;
        }

        .orders td {
            color: black;
        }

        /* Button Styles */
        .btn {
            background-color: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.3s ease;
            margin-top: 20px;
            font-size: 16px;
        }

        .btn:hover {
            background-color: #555;
        }

        /* Footer Styles */
        .footer {
            background-color: #333;
            color: white;
            padding: 20px 0;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .child {
            display: flex;
            justify-content: space-between;
        }

        .footerChild1 img {
            width: 150px;
        }

        .footerChild2 {
            flex: 1;
        }

        .belowfooter {
            text-align: center;
            margin-top: 20px;
        }

        .belowfooter p {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="navbar">
                <div class="logo">
                    <a href="index.html"><img src="./images/header/complogo.png" alt="comp"></a>
                </div>
                <div class="toggle"><i class="fa fa-bars"></i></div>
                <nav class="nav-menu">
                    <ul>
                        <li class="nav-item"><a href="index.html">Home</a></li>
                        <li class="nav-item"><a href="products.html">Products</a></li>
                        <li class="nav-item"><a href="#footer">Contact Us</a></li>
                        <li class="nav-item"><a href="account.html">Account</a></li>
                    </ul>
                </nav>
                <a href="cart.html"><img class="cart" src="./images/header/cart.svg"></a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="profilePage">
            <div class="orders">
                <h3>Order History</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Order Date</th>
                            <th>Status</th>
                            <th>Store Name</th>
                            <th>Product Name</th>
                            <th>Product Image</th>
                            <th>Tracking ID</th>
                            <th>Quantity</th>
                            <th>Expected Delivery</th>
                            <th>Payment Method</th>
                        </tr>
                    </thead>
                    <tbody>
                       <!-- ---Entries will be added here dynamically--- -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="footer" id="footer">
        <div class="container">
            <div class="child">
                <div class="footerChild1">
                    <img src="./images/header/complogo.png" alt="Company Logo">
                    <h4>Mail us at: <a href="mailto:trendsandtimes@iiitd.ac.in">trendsandtimes@iiitd.ac.in</a></h4>
                </div>
                <div class="footerChild2">
                    <h3>Help</h3>
                    <ul>
                        <li><a href="linkgoeshere">Payments</a></li>
                        <li><a href="linkgoeshere">Shipping</a></li>
                        <li><a href="linkgoeshere">Return Policy</a></li>
                        <li><a href="linkgoeshere">FAQ Topics</a></li>
                    </ul>
                </div>
                <div class="footerChild2">
                    <h3>Our Socials</h3>
                    <ul>
                        <li><a href="linkgoeshere">Instagram</a></li>
                        <li><a href="linkgoeshere">Facebook</a></li>
                        <li><a href="linkgoeshere">Twitter</a></li>
                        <li><a href="linkgoeshere">Linkedin</a></li>
                    </ul>
                </div>
                <div class="footerChild2">
                    <h3>Registered Office</h3>
                    <ul>
                        <li>IIITD,</li>
                        <li>Okhla Phase 3,</li>
                        <li>New Delhi-110025</li>
                        <li>-</li>
                    </ul>
                </div>
            </div>
            <div class="belowfooter">
                &copy; Trends and Times, 2024 <br>
                Ramish Jamal, All rights reserved.
            </div>
        </div>
    </div>
    <script>document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            // If token is not available, prompt user to log in
            alert('Please log in to view your order history.');
            return;
        }
    
        // Fetch order history using JWT token
        fetch('http://localhost:3000/user/orders', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch order history');
            }
            return response.json();
        })
        .then(orders => {
            // Extract store IDs from order history
            const storeIds = orders.map(order => order.StoreID);
            // Make requests to fetch store details for each store ID
            Promise.all(storeIds.map(storeId => fetch(`http://localhost:3000/getStoreDetails?storeId=${storeId}`)))
            .then(responses => Promise.all(responses.map(response => response.json())))
            .then(storeDetails => {
                // Render order history with store names
                renderOrderHistoryWithStoreNames(orders, storeDetails);
            })
            .catch(error => {

                console.error('Error fetching store details:', error);
            });
        })
        .catch(error => {
            console.error('Error fetching order history:', error);
        });
    });
    function formatDate(dateTimeString) {
    const date = new Date(dateTimeString);

    // Extracting the date components
    const year = date.getFullYear();
    const month = date.getMonth() + 1; // Adding 1 because getMonth() returns zero-based month
    const day = date.getDate();

    // Format the date
    const formattedDate = `${year}-${month < 10 ? '0' + month : month}-${day < 10 ? '0' + day : day}`;

    return formattedDate;
}


        
async function fetchProductDetails(productId) {
            try {
                // Validate the productId
                if (!productId) {
                    throw new Error("Product ID is required");
                }

                // Make the API call to fetch product details
                const response = await fetch(`http://localhost:3000/getProductDetails?productId=${productId}`);

                // Check if the response is successful
                if (!response.ok) {
                    throw new Error("Failed to fetch product details");
                }

                // Parse the JSON response
                const productDetails = await response.json();

                // Resolve with product details
                return productDetails;
            } catch (error) {
                console.error("Error fetching product details:", error);
                // Reject with error message
                throw new Error("Internal Server Error");
            }
        }

        async function renderOrderHistoryWithStoreNames(orders, storeDetails) {
            const orderHistoryTableBody = document.querySelector('.orders tbody');

            for (const order of orders) {
                // Find store details for the current order
                const storeDetail = storeDetails.find(detail => detail.StoreID === order.StoreID);
                if (storeDetail) {
                    try {
                        // Fetch product details synchronously
                        const productDetails = await fetchProductDetails(order.ProductID);
                        
                        // Create a new table row for the order
                        const newRow = document.createElement('tr');

                        // Populate the row with order and product details
                        newRow.innerHTML = `
                            <td>${formatDate(order.DateTimeOfOrderPlaced)}</td>
                            <td>${order.DeliveryStatus}</td>
                            <td>${storeDetail.StoreName}</td>
                            <td>${productDetails.ItemName}</td>
                            <td><img src="${productDetails.IMAGEURL}" alt="${productDetails.ItemName}" style="max-width: 100px;"></td>
                            <td>${order.TrackingID}</td>
                            <td>${order.NumberOfProducts}</td>
                            <td>${formatDate(order.ExpectedDeliveryTime)}</td>
                            <td>${order.ModeOfPayment}</td>
                        `;

                        // Append the new row to the table body
                        orderHistoryTableBody.appendChild(newRow);
                    } catch (error) {
                        console.error('Error fetching product details:', error);
                        // If there's an error fetching product details, continue to the next order
                        continue;
                    }
                }
            }
        }
    </script>
</body>
</html>

